name: 001-TEST-VERSION

on: 
  workflow_dispatch: 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. ä¸‹è½½ä»£ç 
      - uses: actions/checkout@v4

      # 2. è®¾ç½® Java ç¯å¢ƒ (å¿…é¡»æ˜¯ 17)
      - name: set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. è®¾ç½® Flutter ç¯å¢ƒ
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # 4. ğŸ› ï¸ æ‰§è¡Œå…¨å¥—â€œæš´åŠ›æ‰‹æœ¯â€
      - name: Run Intensive Patch
        run: |
          # å¼ºè¡Œä¿®æ­£ NDK ç‰ˆæœ¬ (ä½¿ç”¨ perl ç¡®ä¿ç²¾å‡†æ’å…¥)
          perl -i -pe 'print "        ndkVersion = \"28.2.13676358\"\n" if /externalNativeBuild/ && !$done++' android/app/build.gradle
          # å¦‚æœä¸Šé¢æ²¡æ’è¿›å»ï¼Œåœ¨ android { åé¢ç›´æ¥æ’
          sed -i '/android {/a \    ndkVersion = "28.2.13676358"' android/app/build.gradle
          
          # å¼ºè¡Œå‡çº§ compileSdkVersion å’Œ targetSdkVersion åˆ° 34 (ç°åœ¨çš„æ ‡å‡†)
          sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 34/g' android/app/build.gradle
          sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 34/g' android/app/build.gradle
          
          # ä¿®æ­£è¿‡æ—¶çš„ l10n é…ç½®
          sed -i '/synthetic-package/d' l10n.yaml
          
          # ä¿®æ­£ä»£ç ä¸­çš„è¿‡æ—¶ API (CardTheme)
          find . -name "*.dart" -exec sed -i 's/CardTheme(/CardThemeData(/g' {} +
          
          # ä¿®æ­£ç¿»è¯‘æ–‡ä»¶ä¸­çš„ç±»å‹å†²çª
          find . -name "*.arb" -exec sed -i 's/"type": "[^"]*"/"type": "Object"/g' {} +
          
          echo "âœ… æš´åŠ›æ‰‹æœ¯å·²å®Œæˆ"

      # 5. è§£å†³é›¶ä»¶ç‰ˆæœ¬å†²çª
      - name: Fix Dependencies
        run: |
          flutter pub add intl:^0.20.2
          flutter pub upgrade

      # 6. æ­£å¼æ‰“åŒ… APK
      - name: Build APK
        run: |
          # ä½¿ç”¨ --no-pub é¿å…å†æ¬¡æ£€æŸ¥ï¼ŒåŠ ä¸Š --debug æé«˜å…¼å®¹æ€§
          flutter build apk --debug --no-pub

      # 7. æœç´¢å¹¶ä¸Šä¼  APK (å³ä½¿å·¥å…·æŠ¥é”™è¯´æ‰¾ä¸åˆ°ï¼Œæˆ‘ä»¬ä¹Ÿæ‰‹åŠ¨æœ)
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: My-BeeCount-APK
          path: "**/*.apk" # æ‰«ææ‰€æœ‰æ–‡ä»¶å¤¹å¯»æ‰¾ç”Ÿæˆçš„ apk
